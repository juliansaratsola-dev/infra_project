# Security Considerations

This document outlines important security considerations for the infrastructure deployment.

## üîê Critical Security Settings

### 1. SSH Access

**Default Configuration** (Development Only):
```hcl
allowed_ssh_cidr = "0.0.0.0/0"  # Allows SSH from anywhere
```

**Production Configuration**:
```hcl
# Restrict to your corporate VPN or specific IPs
allowed_ssh_cidr = "10.0.0.0/8"      # Corporate network
# Or
allowed_ssh_cidr = "203.0.113.0/24"  # Specific IP range
```

**Best Practice**: Use a bastion host or VPN for SSH access in production.

### 2. Kubernetes API Access

**Default Configuration** (Development Only):
The Kubernetes API (port 6443) is open to all IP addresses.

**Production Configuration**:
Modify `terraform/modules/network/main.tf`:

```hcl
ingress {
  from_port   = 6443
  to_port     = 6443
  protocol    = "tcp"
  cidr_blocks = ["10.0.0.0/8"]  # Restrict to your network
  description = "Kubernetes API server"
}
```

**Best Practice**: 
- Use a VPN or bastion host
- Implement network policies
- Enable Kubernetes audit logging

### 3. Rancher Bootstrap Password

**Insecure Configuration**:
```hcl
# Hardcoded password
rancher_bootstrap_password = "admin"
```

**Secure Configuration**:
```hcl
# In terraform.tfvars
rancher_bootstrap_password = "YourStrongRandomPassword123!"

# Or generate dynamically
rancher_bootstrap_password = ""  # Auto-generated by Rancher
```

To retrieve auto-generated password:
```bash
kubectl get secret --namespace cattle-system bootstrap-secret \
  -o go-template='{{.data.bootstrapPassword|base64decode}}{{"\n"}}'
```

**Best Practice**: 
- Use a password manager to generate strong passwords
- Change the password immediately after first login
- Enable two-factor authentication in Rancher

### 4. SSL/TLS Certificates

**Default Configuration**:
The load balancer HTTPS listener is disabled if no certificate is provided.

**Production Configuration**:
```hcl
# In terraform.tfvars
ssl_certificate_arn = "arn:aws:acm:us-east-1:123456789012:certificate/12345678-1234-1234-1234-123456789012"
```

**Best Practice**:
- Use AWS Certificate Manager (ACM) for SSL certificates
- Enable automatic certificate renewal
- Use Let's Encrypt with cert-manager for Kubernetes ingress

### 5. Network Isolation

**VPC Configuration**:
- Public subnets: Only for load balancers and NAT gateways
- Private subnets: For all compute resources
- No direct internet access for private instances

**Security Groups**:
- Minimal required ports open
- Use security group rules instead of CIDR blocks where possible
- Enable VPC Flow Logs for network monitoring

### 6. Data Encryption

**At Rest**:
- All EBS volumes are encrypted by default
- Enable encryption for S3 buckets (if using remote state)
- Use AWS KMS for key management

**In Transit**:
- TLS for all external communications
- mTLS between Kubernetes components
- IPSec for node-to-node communication (optional)

### 7. Secrets Management

**Current State**: Kubernetes secrets (base64 encoded)

**Production Recommendations**:
- Use AWS Secrets Manager or Systems Manager Parameter Store
- Implement External Secrets Operator
- Consider Vault for advanced secret management
- Enable encryption at rest for Kubernetes secrets

```yaml
# Example: Enable encryption for K8s secrets
apiVersion: apiserver.config.k8s.io/v1
kind: EncryptionConfiguration
resources:
  - resources:
      - secrets
    providers:
      - aescbc:
          keys:
            - name: key1
              secret: <base64 encoded secret>
```

## üõ°Ô∏è Security Hardening Checklist

### Pre-Deployment

- [ ] Review and restrict `allowed_ssh_cidr`
- [ ] Set strong `rke2_cluster_token`
- [ ] Configure `rancher_bootstrap_password`
- [ ] Obtain SSL certificate for load balancer
- [ ] Review security group rules
- [ ] Enable AWS CloudTrail
- [ ] Configure VPC Flow Logs

### Post-Deployment

- [ ] Change Rancher admin password
- [ ] Enable 2FA in Rancher
- [ ] Configure Kubernetes RBAC
- [ ] Implement network policies
- [ ] Enable pod security policies
- [ ] Configure audit logging
- [ ] Set up monitoring and alerting
- [ ] Implement backup strategy
- [ ] Review IAM roles and policies
- [ ] Enable AWS GuardDuty

### Kubernetes Security

#### Network Policies

```yaml
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: default-deny-ingress
  namespace: vet-app
spec:
  podSelector: {}
  policyTypes:
  - Ingress
```

#### Pod Security Standards

```yaml
apiVersion: v1
kind: Namespace
metadata:
  name: vet-app
  labels:
    pod-security.kubernetes.io/enforce: restricted
    pod-security.kubernetes.io/audit: restricted
    pod-security.kubernetes.io/warn: restricted
```

#### RBAC

```yaml
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: vet-app-role
  namespace: vet-app
rules:
- apiGroups: [""]
  resources: ["pods", "services"]
  verbs: ["get", "list"]
```

## üîç Security Monitoring

### AWS CloudWatch

Enable logging for:
- VPC Flow Logs
- Load Balancer access logs
- CloudTrail for API calls

### Kubernetes Audit Logs

Enable in RKE2:
```yaml
# /etc/rancher/rke2/config.yaml
audit-policy-file: /etc/rancher/rke2/audit-policy.yaml
```

### Security Scanning

1. **Container Scanning**:
   ```bash
   # Scan Docker images
   docker scan vet-app:latest
   
   # Or use Trivy
   trivy image vet-app:latest
   ```

2. **Kubernetes Security**:
   ```bash
   # Use kubescape
   kubescape scan framework nsa k8s/manifests/
   
   # Or kube-bench
   kubectl apply -f https://raw.githubusercontent.com/aquasecurity/kube-bench/main/job.yaml
   ```

3. **Infrastructure Scanning**:
   ```bash
   # Use Checkov
   checkov -d terraform/
   
   # Or tfsec
   tfsec terraform/
   ```

## üö® Incident Response

### Compromise Response

1. **Isolate affected resources**:
   ```bash
   # Remove node from cluster
   kubectl drain <node-name> --ignore-daemonsets
   kubectl delete node <node-name>
   ```

2. **Review logs**:
   ```bash
   # AWS CloudTrail
   aws cloudtrail lookup-events --lookup-attributes AttributeKey=Username,AttributeValue=<user>
   
   # Kubernetes audit logs
   kubectl logs -n kube-system -l component=kube-apiserver
   ```

3. **Rotate credentials**:
   ```bash
   # Rotate cluster token
   # Update RKE2 configuration and restart services
   
   # Rotate AWS credentials
   aws iam update-access-key --access-key-id <key-id> --status Inactive
   ```

### Security Contacts

- AWS Support: https://aws.amazon.com/premiumsupport/
- Rancher Support: https://rancher.com/support/
- CNCF Security: https://kubernetes.io/docs/reference/issues-security/security/

## üìã Compliance

### Standards to Consider

- **CIS Benchmarks**: Kubernetes, AWS
- **PCI DSS**: If handling payment data
- **HIPAA**: If handling health data
- **GDPR**: If handling EU citizen data
- **SOC 2**: For service providers

### Compliance Tools

```bash
# CIS Kubernetes Benchmark
kube-bench run --targets master,node

# AWS Security Hub
aws securityhub enable-security-hub

# Compliance scanning
checkov --framework kubernetes -d k8s/manifests/
```

## üîÑ Regular Security Tasks

### Daily
- Review CloudWatch logs for anomalies
- Check security alerts

### Weekly
- Review access logs
- Update security group rules if needed
- Check for failed authentication attempts

### Monthly
- Rotate credentials
- Update SSL certificates
- Review IAM permissions
- Scan container images
- Update Kubernetes components

### Quarterly
- Security audit
- Penetration testing
- Review disaster recovery procedures
- Update security documentation

## üìö Additional Resources

- [AWS Security Best Practices](https://aws.amazon.com/security/best-practices/)
- [Kubernetes Security](https://kubernetes.io/docs/concepts/security/)
- [CIS Benchmarks](https://www.cisecurity.org/cis-benchmarks/)
- [OWASP Top 10](https://owasp.org/www-project-top-ten/)
- [Rancher Security](https://rancher.com/docs/rancher/v2.x/en/security/)
- [RKE2 Security](https://docs.rke2.io/security/)

## ‚ö†Ô∏è Important Notes

1. **Development vs Production**: The default configuration is suitable for development/testing only. Production deployments require significant hardening.

2. **Shared Responsibility**: Security is a shared responsibility. While this infrastructure provides a foundation, ongoing security management is required.

3. **Regular Updates**: Keep all components updated with security patches:
   - AWS resources
   - RKE2 Kubernetes
   - Rancher
   - Container images
   - Operating systems

4. **Backup Security**: Ensure backups are encrypted and access-controlled.

5. **Least Privilege**: Always follow the principle of least privilege for IAM roles, RBAC, and network access.
